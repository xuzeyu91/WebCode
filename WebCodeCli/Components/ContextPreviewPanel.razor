@using System.Text.Json
@using WebCodeCli.Domain.Domain.Model
@using WebCodeCli.Domain.Domain.Service
@inject IContextManagerService ContextManagerService
@inject ILocalizationService L

<!-- 上下文预览面板 -->
<div class="@(_isVisible ? "fixed" : "hidden") inset-y-0 right-0 w-96 bg-white shadow-2xl z-50 flex flex-col border-l-2 border-gray-300 transition-all duration-300">
    <!-- 头部 -->
    <div class="p-4 border-b-2 border-gray-200 flex items-center justify-between bg-gradient-to-r from-gray-50 to-white flex-shrink-0">
        <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="text-lg font-bold text-gray-800">@T("contextPreview.title")</h3>
        </div>
        <button @onclick="Close" class="p-2 hover:bg-white rounded-lg transition-colors" title="@T("common.close")">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- 统计信息 -->
    @if (_statistics != null)
    {
        <div class="p-4 bg-gray-50 border-b border-gray-200 flex-shrink-0">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-200">
                    <div class="text-xs text-gray-500 font-medium">@T("contextPreview.tokenUsage")</div>
                    <div class="text-lg font-bold text-gray-700">@_statistics.UsedTokens.ToString("N0")</div>
                    <div class="text-xs text-gray-400">/ @_statistics.TotalTokens.ToString("N0")</div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-200">
                    <div class="text-xs text-gray-500 font-medium">@T("contextPreview.usageRate")</div>
                    <div class="text-lg font-bold @GetUsageColorClass(_statistics.UsagePercentage)">@_statistics.UsagePercentage.ToString("F1")%</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                        <div class="@GetUsageColorClass(_statistics.UsagePercentage) h-2 rounded-full transition-all" style="width: @(_statistics.UsagePercentage)%"></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-200">
                    <div class="text-xs text-gray-500 font-medium">@T("contextPreview.items")</div>
                    <div class="text-lg font-bold text-gray-700">@_statistics.ItemCount</div>
                    <div class="text-xs text-gray-400">@T("contextPreview.included", ("count", _statistics.IncludedItemCount.ToString()))</div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-200">
                    <div class="text-xs text-gray-500 font-medium">@T("contextPreview.remaining")</div>
                    <div class="text-lg font-bold text-green-600">@_statistics.RemainingTokens.ToString("N0")</div>
                    <div class="text-xs text-gray-400">@T("contextPreview.tokens")</div>
                </div>
            </div>
        </div>
    }

    <!-- 工具栏 -->
    <div class="p-3 border-b border-gray-200 flex items-center gap-2 flex-shrink-0 bg-white">
        <input type="text" 
               @bind="_searchKeyword" 
               @bind:event="oninput"
               @onkeyup="HandleSearch"
               placeholder="@T("contextPreview.searchPlaceholder")"
               class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400" />
        
        <select @bind="_filterType" @bind:after="HandleFilterChange" class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400">
            <option value="">@T("contextPreview.filterAll")</option>
            <option value="UserMessage">@T("contextPreview.type.userMessage")</option>
            <option value="AssistantMessage">@T("contextPreview.type.assistantMessage")</option>
            <option value="CodeSnippet">@T("contextPreview.type.codeSnippet")</option>
            <option value="FileReference">@T("contextPreview.type.fileReference")</option>
            <option value="WorkspaceFile">@T("contextPreview.type.workspaceFile")</option>
            <option value="ErrorMessage">@T("contextPreview.type.errorMessage")</option>
        </select>
        
        <button @onclick="ShowCompressDialog" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="@T("contextPreview.compressTitle")">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
        </button>
    </div>

    <!-- 上下文项列表 -->
    <div class="flex-1 overflow-y-auto p-3 space-y-2">
        @if (_filteredItems.Any())
        {
            @foreach (var item in _filteredItems.OrderByDescending(i => i.Priority).ThenByDescending(i => i.CreatedAt))
            {
                <div class="@GetItemCardClass(item) rounded-lg p-3 border-2 transition-all cursor-pointer hover:shadow-md"
                     @onclick="() => ToggleItem(item)">
                    <div class="flex items-start justify-between gap-2 mb-2">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <input type="checkbox" 
                                   checked="@item.IsIncluded" 
                                   @onclick:stopPropagation="true"
                                   @onchange="() => ToggleItem(item)"
                                   class="w-4 h-4 text-gray-600 rounded focus:ring-2 focus:ring-gray-400" />
                            
                            <span class="@GetTypeBadgeClass(item.Type) text-xs font-semibold px-2 py-0.5 rounded-full whitespace-nowrap">
                                @GetTypeDisplayName(item.Type)
                            </span>
                            
                            @if (item.Priority >= 7)
                            {
                                <svg class="w-4 h-4 text-yellow-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                </svg>
                            }
                        </div>
                        
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="text-xs text-gray-500 font-mono">@T("contextPreview.tokensCount", ("count", item.EstimatedTokens.ToString()))</span>
                            
                            <div class="flex gap-1">
                                <button @onclick:stopPropagation="true" @onclick="() => IncreasePriority(item)" class="p-1 hover:bg-gray-100 rounded transition-colors" title="@T("contextPreview.priorityUp")">
                                    <svg class="w-3 h-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                    </svg>
                                </button>
                                <button @onclick:stopPropagation="true" @onclick="() => DecreasePriority(item)" class="p-1 hover:bg-gray-100 rounded transition-colors" title="@T("contextPreview.priorityDown")">
                                    <svg class="w-3 h-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(item.FilePath))
                    {
                        <div class="flex items-center gap-1 mb-1">
                            <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <span class="text-xs text-gray-600 font-mono truncate">@item.FilePath</span>
                        </div>
                    }
                    
                    <div class="text-sm text-gray-700 break-words">
                        @if (!string.IsNullOrEmpty(item.Summary))
                        {
                            <div class="font-medium text-gray-600 mb-1">@item.Summary</div>
                        }
                        
                        @if (item.Content.Length > 150)
                        {
                            <div class="line-clamp-3">@item.Content</div>
                            <button @onclick:stopPropagation="true" @onclick="() => ShowFullContent(item)" class="text-xs text-gray-600 hover:text-gray-800 mt-1">
                                @T("contextPreview.viewFull")
                            </button>
                        }
                        else
                        {
                            <div>@item.Content</div>
                        }
                    </div>
                    
                    @if (item.Tags.Any())
                    {
                        <div class="flex flex-wrap gap-1 mt-2">
                            @foreach (var tag in item.Tags)
                            {
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">@tag</span>
                            }
                        </div>
                    }
                </div>
            }
        }
        else
        {
            <div class="text-center py-12 text-gray-400">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-sm">@T("contextPreview.empty")</p>
            </div>
        }
    </div>

    <!-- 底部操作栏 -->
    <div class="p-3 border-t-2 border-gray-200 flex gap-2 flex-shrink-0 bg-gray-50">
        <button @onclick="RefreshContext" class="flex-1 btn-default text-sm py-2 shadow-sm hover:shadow-md transition-all">
            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            @T("common.refresh")
        </button>
        <button @onclick="ExportContext" class="flex-1 btn-primary text-sm py-2 shadow-md hover:shadow-lg transition-all">
            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            @T("common.export")
        </button>
    </div>
</div>

<!-- 完整内容对话框 -->
@if (_showFullContentDialog && _selectedItem != null)
{
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" @onclick="CloseFullContentDialog">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[80vh] flex flex-col" @onclick:stopPropagation="true">
            <!-- 对话框头部 -->
            <div class="p-6 border-b-2 border-gray-200 flex items-center justify-between bg-gradient-to-r from-gray-50 to-white">
                <div class="flex items-center gap-3">
                    <span class="@GetTypeBadgeClass(_selectedItem.Type) text-sm font-semibold px-3 py-1 rounded-full">
                        @GetTypeDisplayName(_selectedItem.Type)
                    </span>
                    @if (!string.IsNullOrEmpty(_selectedItem.Summary))
                    {
                        <h3 class="text-lg font-bold text-gray-800">@_selectedItem.Summary</h3>
                    }
                    else
                    {
                        <h3 class="text-lg font-bold text-gray-800">@T("contextPreview.fullContent")</h3>
                    }
                </div>
                <button @onclick="CloseFullContentDialog" class="p-2 hover:bg-white rounded-lg transition-colors" title="@T("common.close")">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- 内容区域 -->
            <div class="flex-1 overflow-y-auto p-6">
                @if (!string.IsNullOrEmpty(_selectedItem.FilePath))
                {
                    <div class="flex items-center gap-2 mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        <span class="text-sm text-gray-700 font-mono">@_selectedItem.FilePath</span>
                    </div>
                }

                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <pre class="whitespace-pre-wrap break-words text-sm text-gray-800 font-mono leading-relaxed">@_selectedItem.Content</pre>
                </div>

                @if (_selectedItem.Tags.Any())
                {
                    <div class="mt-4">
                        <div class="text-sm text-gray-500 mb-2">@T("contextPreview.tags")</div>
                        <div class="flex flex-wrap gap-2">
                            @foreach (var tag in _selectedItem.Tags)
                            {
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">@tag</span>
                            }
                        </div>
                    </div>
                }

                <div class="mt-4 grid grid-cols-3 gap-3">
                    <div class="bg-white rounded-lg p-3 border border-gray-200">
                        <div class="text-xs text-gray-500">@T("contextPreview.tokenCount")</div>
                        <div class="text-lg font-bold text-gray-700">@_selectedItem.EstimatedTokens</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border border-gray-200">
                        <div class="text-xs text-gray-500">@T("contextPreview.priority")</div>
                        <div class="text-lg font-bold text-gray-700">@_selectedItem.Priority / 10</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 border border-gray-200">
                        <div class="text-xs text-gray-500">@T("contextPreview.createdAt")</div>
                        <div class="text-sm font-medium text-gray-700">@_selectedItem.CreatedAt.ToString("HH:mm:ss")</div>
                    </div>
                </div>
            </div>

            <!-- 底部按钮 -->
            <div class="p-6 border-t-2 border-gray-200 flex gap-3 bg-gray-50">
                <button @onclick="() => CopyContent(_selectedItem.Content)" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-white transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    @T("contextPreview.copy")
                </button>
                <button @onclick="CloseFullContentDialog" class="flex-1 px-4 py-3 bg-gray-800 hover:bg-black text-white rounded-xl font-medium transition-all shadow-md hover:shadow-lg">
                    @T("common.close")
                </button>
            </div>
        </div>
    </div>
}

<!-- 压缩对话框 -->
@if (_showCompressDialog)
{
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" @onclick="CloseCompressDialog">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6" @onclick:stopPropagation="true">
            <h3 class="text-xl font-bold text-gray-800 mb-4">@T("contextPreview.compressTitle")</h3>
            
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                    <input type="radio" name="compress-strategy" value="KeepRecent" @onchange="() => _selectedStrategy = CompressionStrategy.KeepRecent" checked="@(_selectedStrategy == CompressionStrategy.KeepRecent)" class="w-4 h-4" />
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800">@T("contextPreview.compress.keepRecent")</div>
                        <div class="text-xs text-gray-500">@T("contextPreview.compress.keepRecentDesc")</div>
                    </div>
                </label>
                
                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                    <input type="radio" name="compress-strategy" value="KeepHighPriority" @onchange="() => _selectedStrategy = CompressionStrategy.KeepHighPriority" checked="@(_selectedStrategy == CompressionStrategy.KeepHighPriority)" class="w-4 h-4" />
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800">@T("contextPreview.compress.keepHighPriority")</div>
                        <div class="text-xs text-gray-500">@T("contextPreview.compress.keepHighPriorityDesc")</div>
                    </div>
                </label>
                
                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                    <input type="radio" name="compress-strategy" value="SmartSummary" @onchange="() => _selectedStrategy = CompressionStrategy.SmartSummary" checked="@(_selectedStrategy == CompressionStrategy.SmartSummary)" class="w-4 h-4" />
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800">@T("contextPreview.compress.smartSummary")</div>
                        <div class="text-xs text-gray-500">@T("contextPreview.compress.smartSummaryDesc")</div>
                    </div>
                </label>
                
                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                    <input type="radio" name="compress-strategy" value="RemoveDuplicates" @onchange="() => _selectedStrategy = CompressionStrategy.RemoveDuplicates" checked="@(_selectedStrategy == CompressionStrategy.RemoveDuplicates)" class="w-4 h-4" />
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800">@T("contextPreview.compress.removeDuplicates")</div>
                        <div class="text-xs text-gray-500">@T("contextPreview.compress.removeDuplicatesDesc")</div>
                    </div>
                </label>
            </div>
            
            <div class="flex gap-3">
                <button @onclick="CloseCompressDialog" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">
                    @T("common.cancel")
                </button>
                <button @onclick="CompressContext" disabled="@_isCompressing" class="flex-1 px-4 py-3 bg-gray-800 hover:bg-black text-white rounded-xl font-medium disabled:opacity-50 transition-all shadow-md hover:shadow-lg">
                    @if (_isCompressing)
                    {
                        <span>@T("contextPreview.compressing")</span>
                    }
                    else
                    {
                        <span>@T("contextPreview.compressStart")</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string SessionId { get; set; } = string.Empty;
    [Parameter] public EventCallback OnContextChanged { get; set; }
    
    private bool _isVisible = false;
    private List<ContextItem> _contextItems = new();
    private List<ContextItem> _filteredItems = new();
    private ContextStatistics? _statistics;
    
    private string _searchKeyword = string.Empty;
    private string _filterType = string.Empty;
    
    private bool _showCompressDialog = false;
    private bool _isCompressing = false;
    private CompressionStrategy _selectedStrategy = CompressionStrategy.SmartSummary;
    
    private bool _showFullContentDialog = false;
    private ContextItem? _selectedItem = null;

    // 本地化相关
    private Dictionary<string, string> _translations = new();
    private string _currentLanguage = "zh-CN";
    
    public async Task ShowAsync(string sessionId)
    {
        SessionId = sessionId;
        _isVisible = true;
        _currentLanguage = await L.GetCurrentLanguageAsync();
        await LoadTranslationsAsync();
        await RefreshContext();
    }
    
    public void Close()
    {
        _isVisible = false;
        StateHasChanged();
    }
    
    private async Task RefreshContext()
    {
        _contextItems = ContextManagerService.GetContextItems(SessionId);
        _statistics = ContextManagerService.GetContextStatistics(SessionId);
        ApplyFilters();
        StateHasChanged();
        await Task.CompletedTask;
    }
    
    private void ApplyFilters()
    {
        _filteredItems = _contextItems;
        
        // 应用搜索
        if (!string.IsNullOrWhiteSpace(_searchKeyword))
        {
            _filteredItems = ContextManagerService.SearchContextItems(SessionId, _searchKeyword);
        }
        
        // 应用类型筛选
        if (!string.IsNullOrEmpty(_filterType) && Enum.TryParse<ContextItemType>(_filterType, out var type))
        {
            _filteredItems = _filteredItems.Where(i => i.Type == type).ToList();
        }
    }
    
    private async Task HandleSearch(KeyboardEventArgs e)
    {
        ApplyFilters();
        await Task.CompletedTask;
    }
    
    private async Task HandleFilterChange()
    {
        ApplyFilters();
        await Task.CompletedTask;
    }
    
    private async Task ToggleItem(ContextItem item)
    {
        ContextManagerService.ToggleContextItem(SessionId, item.Id);
        await RefreshContext();
        await OnContextChanged.InvokeAsync();
    }
    
    private async Task IncreasePriority(ContextItem item)
    {
        var newPriority = Math.Min(item.Priority + 1, 10);
        ContextManagerService.UpdateContextItemPriority(SessionId, item.Id, newPriority);
        await RefreshContext();
    }
    
    private async Task DecreasePriority(ContextItem item)
    {
        var newPriority = Math.Max(item.Priority - 1, 0);
        ContextManagerService.UpdateContextItemPriority(SessionId, item.Id, newPriority);
        await RefreshContext();
    }
    
    private void ShowCompressDialog()
    {
        _showCompressDialog = true;
        StateHasChanged();
    }
    
    private void CloseCompressDialog()
    {
        _showCompressDialog = false;
        StateHasChanged();
    }
    
    private async Task CompressContext()
    {
        _isCompressing = true;
        StateHasChanged();
        
        try
        {
            var result = await ContextManagerService.CompressContextAsync(SessionId, _selectedStrategy);
            Console.WriteLine($"压缩完成: 节省 {result.TokensSaved} tokens ({result.CompressionRatio:F1}%)");
            
            await RefreshContext();
            await OnContextChanged.InvokeAsync();
            
            CloseCompressDialog();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"压缩失败: {ex.Message}");
        }
        finally
        {
            _isCompressing = false;
            StateHasChanged();
        }
    }
    
    private async Task ExportContext()
    {
        try
        {
            var json = await ContextManagerService.ExportContextAsync(SessionId);
            // TODO: 触发下载
            Console.WriteLine("上下文已导出");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"导出失败: {ex.Message}");
        }
    }
    
    private void ShowFullContent(ContextItem item)
    {
        _selectedItem = item;
        _showFullContentDialog = true;
        StateHasChanged();
    }
    
    private void CloseFullContentDialog()
    {
        _showFullContentDialog = false;
        _selectedItem = null;
        StateHasChanged();
    }
    
    private async Task CopyContent(string content)
    {
        try
        {
            // TODO: 实现复制到剪贴板功能
            Console.WriteLine("内容已复制到剪贴板");
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"复制失败: {ex.Message}");
        }
    }
    
    private string GetItemCardClass(ContextItem item)
    {
        var baseClass = "bg-white";
        
        if (!item.IsIncluded)
        {
            baseClass += " opacity-50 border-gray-200";
        }
        else if (item.Priority >= 7)
        {
            baseClass += " border-yellow-300 bg-yellow-50";
        }
        else
        {
            baseClass += " border-gray-200";
        }
        
        return baseClass;
    }
    
    private string GetTypeBadgeClass(ContextItemType type)
    {
        return type switch
        {
            ContextItemType.UserMessage => "bg-blue-100 text-blue-700",
            ContextItemType.AssistantMessage => "bg-green-100 text-green-700",
            ContextItemType.CodeSnippet => "bg-purple-100 text-purple-700",
            ContextItemType.FileReference => "bg-orange-100 text-orange-700",
            ContextItemType.WorkspaceFile => "bg-indigo-100 text-indigo-700",
            ContextItemType.ErrorMessage => "bg-red-100 text-red-700",
            _ => "bg-gray-100 text-gray-700"
        };
    }
    
    private string GetTypeDisplayName(ContextItemType type)
    {
        return type switch
        {
            ContextItemType.UserMessage => T("contextPreview.type.user"),
            ContextItemType.AssistantMessage => T("contextPreview.type.assistant"),
            ContextItemType.CodeSnippet => T("contextPreview.type.code"),
            ContextItemType.FileReference => T("contextPreview.type.file"),
            ContextItemType.WorkspaceFile => T("contextPreview.type.workspace"),
            ContextItemType.ErrorMessage => T("contextPreview.type.error"),
            _ => type.ToString()
        };
    }
    
    private string GetUsageColorClass(double percentage)
    {
        if (percentage >= 90) return "text-red-600 bg-red-600";
        if (percentage >= 70) return "text-yellow-600 bg-yellow-600";
        return "text-green-600 bg-green-600";
    }

    #region 本地化辅助方法

    private async Task LoadTranslationsAsync()
    {
        try
        {
            var allTranslations = await L.GetAllTranslationsAsync(_currentLanguage);
            _translations = FlattenTranslations(allTranslations);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[上下文预览] 加载翻译资源失败: {ex.Message}");
        }
    }

    private Dictionary<string, string> FlattenTranslations(Dictionary<string, object> source, string prefix = "")
    {
        var result = new Dictionary<string, string>();

        foreach (var kvp in source)
        {
            var key = string.IsNullOrEmpty(prefix) ? kvp.Key : $"{prefix}.{kvp.Key}";

            if (kvp.Value is JsonElement jsonElement)
            {
                if (jsonElement.ValueKind == JsonValueKind.Object)
                {
                    var nested = JsonSerializer.Deserialize<Dictionary<string, object>>(jsonElement.GetRawText());
                    if (nested != null)
                    {
                        foreach (var item in FlattenTranslations(nested, key))
                        {
                            result[item.Key] = item.Value;
                        }
                    }
                }
                else if (jsonElement.ValueKind == JsonValueKind.String)
                {
                    result[key] = jsonElement.GetString() ?? key;
                }
            }
            else if (kvp.Value is Dictionary<string, object> dict)
            {
                foreach (var item in FlattenTranslations(dict, key))
                {
                    result[item.Key] = item.Value;
                }
            }
            else if (kvp.Value is string str)
            {
                result[key] = str;
            }
        }

        return result;
    }

    private string T(string key)
    {
        if (_translations.TryGetValue(key, out var translation))
        {
            return translation;
        }

        var parts = key.Split('.');
        return parts.Length > 0 ? parts[^1] : key;
    }

    private string T(string key, params (string name, string value)[] parameters)
    {
        var text = T(key);
        foreach (var (name, value) in parameters)
        {
            text = text.Replace($"{{{name}}}", value);
        }
        return text;
    }

    #endregion
}

