@using System.Text.Json
@using WebCodeCli.Domain.Domain.Model
@using WebCodeCli.Domain.Domain.Service
@inject ICliExecutorService CliExecutorService
@inject ICliToolEnvironmentService CliToolEnvironmentService
@inject ILocalizationService L

<div class="env-config-modal">
    @if (_isVisible)
    {
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" @onclick="OnBackgroundClick">
            <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col border border-gray-300" @onclick:stopPropagation="true">
                <!-- 头部 -->
                <div class="flex items-center justify-between p-6 border-b border-gray-300 bg-gray-50 rounded-t-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <h3 class="text-lg font-bold text-gray-800">
                            @(string.IsNullOrWhiteSpace(_selectedTool?.Name)
                                ? T("envConfig.title")
                                : T("envConfig.titleWithTool", ("tool", _selectedTool!.Name)))
                        </h3>
                    </div>
                    <button @onclick="Close" class="text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded-lg p-2 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- 内容区 -->
                <div class="flex-1 overflow-y-auto p-6">
                    @if (_isLoading)
                    {
                        <div class="flex items-center justify-center py-12">
                            <div class="animate-spin h-8 w-8 border-4 border-gray-700 rounded-full border-t-transparent"></div>
                        </div>
                    }
                    else
                    {
                        <div class="space-y-4">
                            <!-- 说明 -->
                            <div class="bg-gray-50 border border-gray-300 rounded-xl p-4 shadow-sm">
                                <div class="flex">
                                    <svg class="w-5 h-5 text-gray-700 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div class="text-sm text-gray-800">
                                        <p class="font-bold mb-2">@T("envConfig.descTitle")</p>
                                        <p class="mb-1">• @T("envConfig.descSaveDb")</p>
                                        <p class="mb-1">• @T("envConfig.descSecretPrefix")<span class="font-semibold text-red-600">@T("envConfig.descSecretHighlight")</span></p>
                                        <p>• @T("envConfig.descReset")</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 环境变量列表 -->
                            @foreach (var (index, kvp) in _envVars.Select((kvp, i) => (i, kvp)))
                            {
                                <div class="card border-gray-300 shadow-sm hover:shadow-md transition-shadow p-4">
                                    <div class="flex gap-4 items-start">
                                        <div class="flex-1">
                                            <label class="block text-sm font-bold text-gray-700 mb-2">@T("envConfig.keyLabel")</label>
                                            <input type="text" 
                                                   @bind="kvp.Key"
                                                   class="w-full px-4 py-2.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-1 focus:ring-gray-500 focus:border-gray-500 text-sm transition-all hover:border-gray-400"
                                                   placeholder="@T("envConfig.keyPlaceholder")" />
                                        </div>
                                        <div class="flex-1">
                                            <label class="block text-sm font-bold text-gray-700 mb-2">@T("envConfig.valueLabel")</label>
                                            <div class="relative">
                                                <input type="password" 
                                                       @bind="kvp.Value"
                                                       autocomplete="off"
                                                       oncopy="return false"
                                                       oncut="return false"
                                                       onpaste="return true"
                                                       class="w-full pl-4 pr-10 py-2.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-1 focus:ring-gray-500 focus:border-gray-500 text-sm transition-all hover:border-gray-400"
                                                       placeholder="@(string.IsNullOrWhiteSpace(kvp.Value) ? T("envConfig.valuePlaceholder") : "••••••••")" />
                                                @if (!string.IsNullOrWhiteSpace(kvp.Value))
                                                {
                                                    <button type="button"
                                                            @onclick="() => ClearValue(index)"
                                                            class="absolute right-1 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-md transition-all z-10"
                                                            title="@T("envConfig.clearValueTitle")">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                        <div class="flex items-end">
                                            <button @onclick="() => RemoveEnvVar(index)" 
                                                    class="p-2.5 text-red-600 hover:bg-red-50 hover:text-red-700 rounded-xl transition-all border border-transparent hover:border-red-200"
                                                    title="@T("envConfig.removeTitle")">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- 添加按钮 -->
                            <button @onclick="AddEnvVar" 
                                    class="w-full py-3 border-2 border-dashed border-gray-400 rounded-xl hover:border-gray-600 hover:bg-gray-50 transition-all flex items-center justify-center gap-2 text-gray-700 hover:text-gray-900 font-semibold group">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <span>@T("envConfig.addButton")</span>
                            </button>
                        </div>
                    }
                </div>

                <!-- 底部按钮 -->
                <div class="flex items-center justify-between p-6 border-t border-gray-300 bg-gray-50 rounded-b-2xl">
                    <button @onclick="ResetToDefault" 
                            disabled="@_isLoading"
                            class="px-5 py-2.5 text-sm font-semibold text-amber-700 bg-white border border-amber-300 rounded-xl hover:bg-amber-50 hover:border-amber-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm hover:shadow">
                        @T("envConfig.resetButton")
                    </button>
                    <div class="flex gap-3">
                        <button @onclick="Close" 
                                disabled="@_isLoading"
                                class="btn-default disabled:opacity-50 disabled:cursor-not-allowed">
                            @T("common.cancel")
                        </button>
                        <button @onclick="Save" 
                                disabled="@_isLoading"
                                class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed min-w-[100px]">
                            @if (_isLoading)
                            {
                                <div class="flex items-center gap-2">
                                    <div class="animate-spin h-4 w-4 border-2 border-white rounded-full border-t-transparent"></div>
                                    <span>@T("envConfig.saving")</span>
                                </div>
                            }
                            else
                            {
                                <span>@T("envConfig.save")</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool _isVisible = false;
    private bool _isLoading = false;
    private CliToolConfig? _selectedTool;
    private List<EnvVarItem> _envVars = new();

    // 本地化相关
    private Dictionary<string, string> _translations = new();
    private string _currentLanguage = "zh-CN";

    private class EnvVarItem
    {
        public string Key { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadTranslationsAsync();
    }

    public async Task ShowAsync(CliToolConfig tool)
    {
        _selectedTool = tool;
        _isVisible = true;
        _isLoading = true;
        StateHasChanged();

        try
        {
            _currentLanguage = await L.GetCurrentLanguageAsync();
            await LoadTranslationsAsync();
            var envVars = await CliToolEnvironmentService.GetEnvironmentVariablesAsync(tool.Id);
            _envVars = envVars.Select(kvp => new EnvVarItem { Key = kvp.Key, Value = kvp.Value }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载环境变量失败: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void Close()
    {
        _isVisible = false;
        _selectedTool = null;
        _envVars.Clear();
        StateHasChanged();
    }

    private void OnBackgroundClick()
    {
        Close();
    }

    private void AddEnvVar()
    {
        _envVars.Add(new EnvVarItem());
        StateHasChanged();
    }

    private void RemoveEnvVar(int index)
    {
        if (index >= 0 && index < _envVars.Count)
        {
            _envVars.RemoveAt(index);
            StateHasChanged();
        }
    }

    private void ClearValue(int index)
    {
        if (index >= 0 && index < _envVars.Count)
        {
            _envVars[index].Value = string.Empty;
            StateHasChanged();
        }
    }

    private async Task Save()
    {
        if (_selectedTool == null) return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            // 过滤掉空的键或空的值的环境变量，只保存有实际值的配置
            var validEnvVars = _envVars
                .Where(ev => !string.IsNullOrWhiteSpace(ev.Key) && !string.IsNullOrWhiteSpace(ev.Value))
                .ToDictionary(ev => ev.Key.Trim(), ev => ev.Value!.Trim());

            var success = await CliToolEnvironmentService.SaveEnvironmentVariablesAsync(_selectedTool.Id, validEnvVars);
            
            if (success)
            {
                Console.WriteLine("环境变量保存成功");
                Close();
            }
            else
            {
                Console.WriteLine("环境变量保存失败");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"保存环境变量失败: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ResetToDefault()
    {
        if (_selectedTool == null) return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            var defaultEnvVars = await CliToolEnvironmentService.ResetToDefaultAsync(_selectedTool.Id);
            _envVars = defaultEnvVars.Select(kvp => new EnvVarItem { Key = kvp.Key, Value = kvp.Value }).ToList();
            Console.WriteLine("已重置为默认配置");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"重置失败: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    #region 本地化辅助方法

    private async Task LoadTranslationsAsync()
    {
        try
        {
            var allTranslations = await L.GetAllTranslationsAsync(_currentLanguage);
            _translations = FlattenTranslations(allTranslations);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[环境变量配置] 加载翻译资源失败: {ex.Message}");
        }
    }

    private Dictionary<string, string> FlattenTranslations(Dictionary<string, object> source, string prefix = "")
    {
        var result = new Dictionary<string, string>();

        foreach (var kvp in source)
        {
            var key = string.IsNullOrEmpty(prefix) ? kvp.Key : $"{prefix}.{kvp.Key}";

            if (kvp.Value is JsonElement jsonElement)
            {
                if (jsonElement.ValueKind == JsonValueKind.Object)
                {
                    var nested = JsonSerializer.Deserialize<Dictionary<string, object>>(jsonElement.GetRawText());
                    if (nested != null)
                    {
                        foreach (var item in FlattenTranslations(nested, key))
                        {
                            result[item.Key] = item.Value;
                        }
                    }
                }
                else if (jsonElement.ValueKind == JsonValueKind.String)
                {
                    result[key] = jsonElement.GetString() ?? key;
                }
            }
            else if (kvp.Value is Dictionary<string, object> dict)
            {
                foreach (var item in FlattenTranslations(dict, key))
                {
                    result[item.Key] = item.Value;
                }
            }
            else if (kvp.Value is string str)
            {
                result[key] = str;
            }
        }

        return result;
    }

    private string T(string key)
    {
        if (_translations.TryGetValue(key, out var translation))
        {
            return translation;
        }

        var parts = key.Split('.');
        return parts.Length > 0 ? parts[^1] : key;
    }

    private string T(string key, params (string name, string value)[] parameters)
    {
        var text = T(key);
        foreach (var (name, value) in parameters)
        {
            text = text.Replace($"{{{name}}}", value);
        }
        return text;
    }

    #endregion
}
